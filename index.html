<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador APU</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f7fa; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #2c3e50; text-align: center; }
        .tabs { display: flex; justify-content: center; margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; margin: 0 5px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .tab-button:hover { background-color: #2980b9; }
        .tab-button.active { background-color: #2c3e50; }
        .tab-content { display: none; background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #2c3e50; color: white; }
        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { padding: 10px 20px; background-color: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #219653; }
        #listaCotizaciones div { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .aiu-fields { display: none; }
        .aiu-fields.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cotizador APU</h1>
        <div class="tabs">
            <button class="tab-button active" onclick="openTab('apu')">APU</button>
            <button class="tab-button" onclick="openTab('cotizacion')">Cotización</button>
            <button class="tab-button" onclick="openTab('consultar')">Consultar Cotizaciones</button>
        </div>

        <div id="apu" class="tab-content active">
            <h2>Análisis de Precios Unitarios</h2>
            <button onclick="descargarPlantilla()">Descargar Plantilla APU</button>
            <input type="file" id="apuFile" accept=".xlsx" onchange="leerExcel(event)">
            <table id="apuTable">
                <thead>
                    <tr>
                        <th>Categoría</th>
                        <th>Concepto</th>
                        <th>Unidad</th>
                        <th>Cantidad</th>
                        <th>Valor Unitario</th>
                        <th>Valor Total</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <p>Total APU: <span id="totalAPU">$ 0.00</span></p>
            <label for="margen_contributivo">Margen Contributivo (%):</label>
            <input type="number" id="margen_contributivo" value="10" min="0" step="0.1">
            <p>Total APU con Margen: <span id="totalAPUMargen">$ 0.00</span></p>
        </div>

        <div id="cotizacion" class="tab-content">
            <h2>Cotización</h2>
            <label for="consecutivo">Consecutivo:</label>
            <span id="consecutivo">001</span>
            <label for="nombreCliente">Nombre del Cliente:</label>
            <input type="text" id="nombreCliente">
            <label for="proyecto">Proyecto:</label>
            <input type="text" id="proyecto">
            <label for="descripcion">Descripción del Servicio:</label>
            <textarea id="descripcion" rows="4"></textarea>
            <label for="precioUnitario">Precio Unitario:</label>
            <input type="number" id="precioUnitario" oninput="calcularCotizacion()">
            <label for="unidadMedida">Unidad de Medida:</label>
            <select id="unidadMedida" onchange="calcularCotizacion()">
                <option value="Und">Unidad</option>
                <option value="m2">Metros Cuadrados</option>
                <option value="m3">Metros Cúbicos</option>
            </select>
            <label for="cantidad">Cantidad:</label>
            <input type="number" id="cantidad" oninput="calcularCotizacion()">
            <label for="moneda">Moneda:</label>
            <select id="moneda" onchange="actualizarLabelMoneda(); calcularCotizacion()">
                <option value="COP">COP</option>
                <option value="USD">USD</option>
            </select>
            <label for="tasaCambio">Tasa de Cambio (COP/USD):</label>
            <input type="number" id="tasaCambio" oninput="calcularCotizacion()">
            <label id="labelPrecioUnitarioMoneda">Precio Unitario en Moneda:</label>
            <span id="precioUnitarioMoneda">$ 0.00</span>
            <label for="conAIU">Incluir AIU:</label>
            <input type="checkbox" id="conAIU" onchange="toggleAIUFields(); calcularCotizacion()">
            <div id="aiuFields" class="aiu-fields">
                <label for="administrativo">Administración (%):</label>
                <input type="number" id="administrativo" value="10" oninput="calcularCotizacion()">
                <span id="valorAdministrativo">$ 0.00</span>
                <label for="imprevistos">Imprevistos (%):</label>
                <input type="number" id="imprevistos" value="5" oninput="calcularCotizacion()">
                <span id="valorImprevistos">$ 0.00</span>
                <label for="utilidad">Utilidad (%):</label>
                <input type="number" id="utilidad" value="15" oninput="calcularCotizacion()">
                <span id="valorUtilidad">$ 0.00</span>
                <p>Valor Total AIU: <span id="valorAIU">$ 0.00</span></p>
            </div>
            <p>IVA: <span id="iva">$ 0.00</span></p>
            <p>Precio Unitario por Cantidad: <span id="precioUnitarioCantidad">$ 0.00</span></p>
            <label for="formaPago">Forma de Pago:</label>
            <input type="text" id="formaPago">
            <label for="porcentajeAnticipo">Porcentaje de Anticipo (%):</label>
            <input type="number" id="porcentajeAnticipo" value="30" oninput="calcularCotizacion()">
            <span id="valorAnticipo">$ 0.00</span>
            <label for="tiempoEntrega">Tiempo de Entrega:</label>
            <input type="text" id="tiempoEntrega">
            <p>Precio Total: <span id="precioTotal">$ 0.00</span></p>
            <button onclick="descargarCotizacion()">Descargar PDF</button>
        </div>

        <div id="consultar" class="tab-content">
            <h2>Consultar Cotizaciones</h2>
            <input type="text" id="buscarCliente" placeholder="Buscar por cliente o proyecto" oninput="filtrarCotizaciones()">
            <div id="listaCotizaciones"></div>
            <button onclick="exportarCotizaciones()">Exportar Cotizaciones</button>
            <input type="file" id="importarCotizaciones" accept=".json" onchange="importarCotizaciones(this.files)">
            <label for="importarCotizaciones">Importar Cotizaciones</label>
        </div>
    </div>

    <script>
        const msalConfig = {
            auth: {
                clientId: "d7dc1b41-eae3-46ed-810a-108e4db85941",
                authority: "https://login.microsoftonline.com/common",
                redirectUri: "https://alexmao84.github.io/cotizador-apu/"
            },
            cache: {
                cacheLocation: "localStorage"
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let currentAccount = null;
        let accessToken = null;

        async function getAccessToken() {
            if (accessToken) return accessToken;

            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                currentAccount = accounts[0];
            }

            if (currentAccount) {
                try {
                    const silentRequest = {
                        scopes: ["User.Read", "Files.ReadWrite"],
                        account: currentAccount
                    };
                    const response = await msalInstance.acquireTokenSilent(silentRequest);
                    accessToken = response.accessToken;
                    return accessToken;
                } catch (error) {
                    console.log("Fallo en acquireTokenSilent, intentando loginPopup:", error);
                }
            }

            try {
                const loginResponse = await msalInstance.loginPopup({
                    scopes: ["User.Read", "Files.ReadWrite"]
                });
                currentAccount = loginResponse.account;
                accessToken = loginResponse.accessToken;
                console.log("Usuario autenticado:", currentAccount);
                return accessToken;
            } catch (error) {
                console.error("Error en autenticación:", error);
                throw error;
            }
        }

        const categorias = ["Preliminares", "Administrativo", "ManoObra", "Materiales", "SST", "LogisticaTransporte", "HerramientasEquipos", "Viaticos"];

        function formatNumber(number) {
            const parts = number.toFixed(2).split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return parts.join('.');
        }

        function formatCurrency(number, moneda = 'COP') {
            return `$ ${formatNumber(number)} ${moneda}`;
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab-button[onclick="openTab('${tabName}')"]`).classList.add('active');
            if (tabName === 'cotizacion') {
                calcularCotizacion();
                actualizarConsecutivo();
                actualizarTasaCambio();
                actualizarLabelMoneda();
                toggleAIUFields();
            } else if (tabName === 'consultar') {
                filtrarCotizaciones();
            }
        }

        function descargarPlantilla() {
            const wb = XLSX.utils.book_new();
            const ws_data = [
                ["Categoría", "Concepto", "Unidad", "Cantidad", "Valor Unitario", "Valor Total"],
                ...categorias.map(cat => [cat, "", "", "", "", ""])
            ];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "APU");
            XLSX.writeFile(wb, "plantilla_apu.xlsx");
        }

        function leerExcel(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: ["Categoría", "Concepto", "Unidad", "Cantidad", "Valor Unitario", "Valor Total"], range: 1 });
                const tbody = document.querySelector("#apuTable tbody");
                tbody.innerHTML = "";
                json.forEach(row => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${row["Categoría"]}</td>
                        <td>${row["Concepto"] || ""}</td>
                        <td>${row["Unidad"] || ""}</td>
                        <td>${row["Cantidad"] || ""}</td>
                        <td>${row["Valor Unitario"] || ""}</td>
                        <td>${row["Valor Total"] || ""}</td>
                    `;
                    tbody.appendChild(tr);
                });
                calcularAPU();
            };
            reader.readAsArrayBuffer(file);
        }

        function calcularAPU() {
            const rows = document.querySelectorAll("#apuTable tbody tr");
            let total = 0;
            rows.forEach(row => {
                const cantidad = parseFloat(row.cells[3].textContent) || 0;
                const valorUnitario = parseFloat(row.cells[4].textContent) || 0;
                const valorTotal = cantidad * valorUnitario;
                row.cells[5].textContent = formatCurrency(valorTotal);
                total += valorTotal;
            });
            document.getElementById("totalAPU").textContent = formatCurrency(total);
            const margen = parseFloat(document.getElementById("margen_contributivo").value) || 0;
            const totalMargen = total * (1 + margen / 100);
            document.getElementById("totalAPUMargen").textContent = formatCurrency(totalMargen);
            document.getElementById("precioUnitario").value = totalMargen.toFixed(2);
            calcularCotizacion();
        }

        function actualizarConsecutivo() {
            obtenerCotizacionesDesdeSharePoint().then(cotizaciones => {
                const ultimo = cotizaciones.length > 0 ? Math.max(...cotizaciones.map(c => parseInt(c.consecutivo))) : 0;
                document.getElementById("consecutivo").textContent = String(ultimo + 1).padStart(3, '0');
            });
        }

        function incrementarConsecutivo() {
            const actual = parseInt(document.getElementById("consecutivo").textContent);
            const nuevo = String(actual + 1).padStart(3, '0');
            document.getElementById("consecutivo").textContent = nuevo;
            return document.getElementById("consecutivo").textContent;
        }

        function actualizarTasaCambio() {
            fetch('https://api.exchangerate-api.com/v4/latest/USD')
                .then(response => response.json())
                .then(data => {
                    document.getElementById("tasaCambio").value = data.rates.COP.toFixed(2);
                    calcularCotizacion();
                })
                .catch(() => {
                    document.getElementById("tasaCambio").value = "4100";
                    calcularCotizacion();
                });
        }

        function actualizarLabelMoneda() {
            const moneda = document.getElementById("moneda").value;
            document.getElementById("labelPrecioUnitarioMoneda").textContent = `Precio Unitario en ${moneda}:`;
            toggleAIUFields();
            calcularCotizacion();
        }

        function toggleAIUFields() {
            const conAIU = document.getElementById("conAIU").checked && document.getElementById("moneda").value === "COP";
            document.getElementById("aiuFields").classList.toggle("active", conAIU);
        }

        function calcularCotizacion() {
            const precioUnitario = parseFloat(document.getElementById("precioUnitario").value) || 0;
            const cantidad = parseFloat(document.getElementById("cantidad").value) || 1;
            const moneda = document.getElementById("moneda").value;
            const tasaCambio = parseFloat(document.getElementById("tasaCambio").value) || 1;
            let precioUnitarioMoneda = precioUnitario;

            if (moneda === "USD") {
                precioUnitarioMoneda = precioUnitario * tasaCambio;
            }
            document.getElementById("precioUnitarioMoneda").textContent = formatCurrency(precioUnitarioMoneda, moneda === "COP" ? "COP" : "COP");

            let precioUnitarioCantidad = precioUnitario * cantidad;
            let valorAIU = 0;

            if (moneda === "COP" && document.getElementById("conAIU").checked) {
                const administrativo = parseFloat(document.getElementById("administrativo").value) / 100 || 0;
                const imprevistos = parseFloat(document.getElementById("imprevistos").value) / 100 || 0;
                const utilidad = parseFloat(document.getElementById("utilidad").value) / 100 || 0;

                const valorAdministrativo = precioUnitario * administrativo;
                const valorImprevistos = precioUnitario * imprevistos;
                const valorUtilidad = precioUnitario * utilidad;

                document.getElementById("valorAdministrativo").textContent = formatCurrency(valorAdministrativo);
                document.getElementById("valorImprevistos").textContent = formatCurrency(valorImprevistos);
                document.getElementById("valorUtilidad").textContent = formatCurrency(valorUtilidad);

                valorAIU = valorAdministrativo + valorImprevistos + valorUtilidad;
                document.getElementById("valorAIU").textContent = formatCurrency(valorAIU);

                precioUnitarioCantidad = (precioUnitario + valorAIU) * cantidad;
            }

            const iva = moneda === "COP" ? precioUnitarioCantidad * 0.19 : 0;
            document.getElementById("iva").textContent = formatCurrency(iva);

            const precioUnitarioCantidadTotal = precioUnitarioCantidad;
            document.getElementById("precioUnitarioCantidad").textContent = formatCurrency(precioUnitarioCantidadTotal);

            const precioTotal = precioUnitarioCantidad + iva;
            document.getElementById("precioTotal").textContent = formatCurrency(precioTotal);

            const porcentajeAnticipo = parseFloat(document.getElementById("porcentajeAnticipo").value) / 100 || 0;
            const valorAnticipo = precioTotal * porcentajeAnticipo;
            document.getElementById("valorAnticipo").textContent = formatCurrency(valorAnticipo);
        }

        async function descargarCotizacion() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 10;
                const unidadMedida = document.getElementById("unidadMedida").value;
                const moneda = document.getElementById("moneda").value;
                const nombreCliente = document.getElementById("nombreCliente").value;
                const proyecto = document.getElementById("proyecto").value;
                const cantidad = document.getElementById("cantidad").value;
                const formaPago = document.getElementById("formaPago").value;
                const porcentajeAnticipo = document.getElementById("porcentajeAnticipo").value;
                const valorAnticipo = document.getElementById("valorAnticipo").textContent;
                const tiempoEntrega = document.getElementById("tiempoEntrega").value;
                const consecutivo = incrementarConsecutivo();
                let y = margin;

                doc.setFontSize(18);
                doc.setTextColor(44, 62, 80);
                doc.text("Cotización", pageWidth / 2, y, { align: "center" });
                y += 10;
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Cotización No: ${consecutivo}`, pageWidth - margin, y, { align: "right" });
                y += 5;
                doc.text(`Fecha: ${new Date().toLocaleDateString()}`, pageWidth - margin, y, { align: "right" });
                y += 10;

                doc.setLineWidth(0.5);
                doc.setDrawColor(33, 150, 243);
                doc.line(margin, y, pageWidth - margin, y);
                y += 10;

                doc.setFontSize(12);
                doc.setTextColor(44, 62, 80);
                doc.text(`Cliente: ${nombreCliente}`, margin, y);
                y += 5;
                doc.text(`Proyecto: ${proyecto}`, margin, y);
                y += 10;
                doc.text("Descripción del Servicio:", margin, y);
                doc.text(document.getElementById('descripcion').value, margin + 5, y + 5, { maxWidth: pageWidth - margin * 2 });
                y += Math.ceil(doc.getTextDimensions(document.getElementById('descripcion').value, { maxWidth: pageWidth - margin * 2 }).h) + 10;

                const detallesHeaders = ["Concepto", "Valor"];
                let detallesBody = [
                    [`Precio Unitario (${unidadMedida})`, document.getElementById('precioUnitario').value],
                    [document.getElementById('labelPrecioUnitarioMoneda').textContent, document.getElementById('precioUnitarioMoneda').textContent],
                    ["Cantidad", `${cantidad} ${unidadMedida}`]
                ];

                if (moneda === "COP") {
                    if (document.getElementById("conAIU").checked) {
                        detallesBody.push(["Administración", `${document.getElementById('administrativo').value}% (${document.getElementById('valorAdministrativo').textContent})`]);
                        detallesBody.push(["Imprevistos", `${document.getElementById('imprevistos').value}% (${document.getElementById('valorImprevistos').textContent})`]);
                        detallesBody.push(["Utilidad", `${document.getElementById('utilidad').value}% (${document.getElementById('valorUtilidad').textContent})`]);
                        detallesBody.push(["Valor Total AIU", document.getElementById('valorAIU').textContent]);
                    }
                    detallesBody.push(["IVA", document.getElementById('iva').textContent]);
                }

                detallesBody.push(["Precio Unitario por Cantidad", document.getElementById('precioUnitarioCantidad').textContent]);

                doc.autoTable({
                    startY: y,
                    head: [detallesHeaders],
                    body: detallesBody,
                    theme: 'grid',
                    styles: { fontSize: 10, cellPadding: 2, textColor: [44, 62, 80] },
                    headStyles: { fillColor: [44, 62, 80], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [245, 247, 250] },
                    columnStyles: {
                        0: { halign: 'left' },
                        1: { halign: 'right' }
                    }
                });
                y = doc.lastAutoTable.finalY + 10;

                doc.setFontSize(12);
                doc.setTextColor(44, 62, 80);
                doc.text("Condiciones de la Cotización:", margin, y);
                y += 7;
                doc.setFontSize(10);
                const condiciones = [
                    "1. Validez de la cotización: 30 días a partir de la fecha de emisión.",
                    "2. Los precios no incluyen impuestos adicionales salvo los especificados.",
                    `3. Forma de pago: ${formaPago}.`,
                    `4. Anticipo: ${porcentajeAnticipo}% (${valorAnticipo}).`,
                    `5. Tiempo de entrega: ${tiempoEntrega}.`
                ];
                condiciones.forEach((condicion, index) => {
                    doc.text(condicion, margin + 5, y + (index * 5), { maxWidth: pageWidth - margin * 2 });
                });
                y += condiciones.length * 5 + 10;

                doc.setFillColor(232, 245, 233);
                doc.rect(margin, y, pageWidth - margin * 2, 10, 'F');
                doc.setFontSize(14);
                doc.setTextColor(76, 175, 80);
                doc.text(`Precio Total: ${document.getElementById('precioTotal').textContent}`, pageWidth - margin, y + 7, { align: "right" });

                const pdfBlob = doc.output("blob");
                const fileName = `cotizacion_${consecutivo}_${moneda}_profesional.pdf`;

                const accessToken = await getAccessToken();
                const url = "https://graph.microsoft.com/v1.0/sites/selco534.sharepoint.com,xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx,yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy/drives/b!KxRr5AdKekWRE2On77gV-_REcnJYw_BJqAH5TSSxbCFOxffOJMG9RJ5EaCkpnjUS/root:/03. Obras cotizadas/Cotizaciones WEB/" + fileName + ":/content";
                const response = await fetch(url, {
                    method: "PUT",
                    headers: {
                        "Authorization": "Bearer " + accessToken,
                        "Content-Type": "application/pdf"
                    },
                    body: pdfBlob
                });
                if (!response.ok) throw new Error("Error al subir a SharePoint: " + response.statusText);
                console.log("PDF subido a SharePoint:", fileName);

                doc.save(fileName);
                await guardarCotizacion();
                actualizarConsecutivo();
            } catch (error) {
                console.error("Error en descargarCotizacion:", error);
                alert("Error al generar o subir el PDF. Revisa la consola.");
            }
        }

        async function guardarCotizacion() {
            const cotizacion = {
                consecutivo: document.getElementById("consecutivo").textContent,
                fecha: new Date().toLocaleDateString(),
                cliente: document.getElementById("nombreCliente").value,
                proyecto: document.getElementById("proyecto").value,
                descripcion: document.getElementById("descripcion").value,
                precioUnitario: document.getElementById("precioUnitario").value,
                unidadMedida: document.getElementById("unidadMedida").value,
                cantidad: document.getElementById("cantidad").value,
                moneda: document.getElementById("moneda").value,
                tasaCambio: document.getElementById("tasaCambio").value,
                precioUnitarioMoneda: document.getElementById("precioUnitarioMoneda").textContent,
                conAIU: document.getElementById("conAIU").checked,
                administrativo: document.getElementById("administrativo").value,
                imprevistos: document.getElementById("imprevistos").value,
                utilidad: document.getElementById("utilidad").value,
                valorAdministrativo: document.getElementById("valorAdministrativo").textContent,
                valorImprevistos: document.getElementById("valorImprevistos").textContent,
                valorUtilidad: document.getElementById("valorUtilidad").textContent,
                valorAIU: document.getElementById("valorAIU").textContent,
                iva: document.getElementById("iva").textContent,
                precioUnitarioCantidad: document.getElementById("precioUnitarioCantidad").textContent,
                precioTotal: document.getElementById("precioTotal").textContent,
                formaPago: document.getElementById("formaPago").value,
                porcentajeAnticipo: document.getElementById("porcentajeAnticipo").value,
                valorAnticipo: document.getElementById("valorAnticipo").textContent,
                tiempoEntrega: document.getElementById("tiempoEntrega").value
            };

            let cotizaciones = await obtenerCotizacionesDesdeSharePoint() || [];
            cotizaciones.push(cotizacion);

            const jsonBlob = new Blob([JSON.stringify(cotizaciones, null, 2)], { type: "application/json" });
            const accessToken = await getAccessToken();
            const url = "https://graph.microsoft.com/v1.0/sites/selco534.sharepoint.com,xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx,yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy/drives/b!KxRr5AdKekWRE2On77gV-_REcnJYw_BJqAH5TSSxbCFOxffOJMG9RJ5EaCkpnjUS/root:/03. Obras cotizadas/Cotizaciones WEB/cotizaciones.json:/content";
            const response = await fetch(url, {
                method: "PUT",
                headers: {
                    "Authorization": "Bearer " + accessToken,
                    "Content-Type": "application/json"
                },
                body: jsonBlob
            });
            if (!response.ok) throw new Error("Error al guardar cotizaciones en SharePoint");
            console.log("Cotizaciones guardadas en SharePoint");
        }

        async function obtenerCotizacionesDesdeSharePoint() {
            const accessToken = await getAccessToken();
            const url = "https://graph.microsoft.com/v1.0/sites/selco534.sharepoint.com,xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx,yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy/drives/b!KxRr5AdKekWRE2On77gV-_REcnJYw_BJqAH5TSSxbCFOxffOJMG9RJ5EaCkpnjUS/root:/03. Obras cotizadas/Cotizaciones WEB/cotizaciones.json:/content";
            try {
                const response = await fetch(url, {
                    headers: { "Authorization": "Bearer " + accessToken }
                });
                if (response.ok) {
                    const jsonText = await response.text();
                    return JSON.parse(jsonText);
                }
                return [];
            } catch (error) {
                console.log("No se encontró cotizaciones.json en SharePoint aún.");
                return [];
            }
        }

        async function filtrarCotizaciones() {
            const buscar = document.getElementById("buscarCliente").value.toLowerCase();
            const cotizaciones = await obtenerCotizacionesDesdeSharePoint();
            let lista = document.getElementById("listaCotizaciones");
            lista.innerHTML = "";

            cotizaciones.forEach((cotizacion, index) => {
                if (cotizacion.cliente.toLowerCase().includes(buscar) || 
                    cotizacion.proyecto.toLowerCase().includes(buscar)) {
                    let div = document.createElement("div");
                    div.innerHTML = `
                        <h3>Cotización No: ${cotizacion.consecutivo}</h3>
                        <p>Cliente: ${cotizacion.cliente}</p>
                        <p>Proyecto: ${cotizacion.proyecto}</p>
                        <p>Fecha: ${cotizacion.fecha}</p>
                        <p>Precio Total: ${cotizacion.precioTotal}</p>
                        <button onclick="verDetalles(${index})">Ver Detalles</button>
                    `;
                    lista.appendChild(div);
                }
            });
        }

        function verDetalles(index) {
            obtenerCotizacionesDesdeSharePoint().then(cotizaciones => {
                let cotizacion = cotizaciones[index];
                if (!cotizacion) return;

                let detalles = document.createElement('div');
                detalles.innerHTML = `
                    <h3>Detalles de la Cotización No: ${cotizacion.consecutivo}</h3>
                    <p>Cliente: ${cotizacion.cliente}</p>
                    <p>Proyecto: ${cotizacion.proyecto}</p>
                    <p>Descripción: ${cotizacion.descripcion}</p>
                    <p>Precio Unitario: ${cotizacion.precioUnitario}</p>
                    <p>Unidad de Medida: ${cotizacion.unidadMedida}</p>
                    <p>Cantidad: ${cotizacion.cantidad}</p>
                    <p>Moneda: ${cotizacion.moneda}</p>
                    <p>Tasa de Cambio: ${cotizacion.tasaCambio}</p>
                    <p>Precio Unitario en ${cotizacion.moneda}: ${cotizacion.precioUnitarioMoneda}</p>
                    ${cotizacion.conAIU ? `
                        <p>Administración: ${cotizacion.administrativo}% (${cotizacion.valorAdministrativo})</p>
                        <p>Imprevistos: ${cotizacion.imprevistos}% (${cotizacion.valorImprevistos})</p>
                        <p>Utilidad: ${cotizacion.utilidad}% (${cotizacion.valorUtilidad})</p>
                        <p>Valor Total AIU: ${cotizacion.valorAIU}</p>
                    ` : ''}
                    <p>IVA: ${cotizacion.iva}</p>
                    <p>Precio Unitario por Cantidad: ${cotizacion.precioUnitarioCantidad}</p>
                    <p>Precio Total: ${cotizacion.precioTotal}</p>
                    <p>Forma de Pago: ${cotizacion.formaPago}</p>
                    <p>Anticipo: ${cotizacion.porcentajeAnticipo}% (${cotizacion.valorAnticipo})</p>
                    <p>Tiempo de Entrega: ${cotizacion.tiempoEntrega}</p>
                    <button onclick="cerrarDetalles(this)">Cerrar</button>
                `;
                document.getElementById("listaCotizaciones").appendChild(detalles);
            });
        }

        function cerrarDetalles(button) {
            button.parentElement.remove();
        }

        async function exportarCotizaciones() {
            const cotizaciones = await obtenerCotizacionesDesdeSharePoint();
            const json = JSON.stringify(cotizaciones, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cotizaciones.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        async function importarCotizaciones(files) {
            const file = files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const nuevasCotizaciones = JSON.parse(e.target.result);
                    let cotizacionesExistentes = await obtenerCotizacionesDesdeSharePoint() || [];
                    
                    nuevasCotizaciones.forEach(nueva => {
                        if (!cotizacionesExistentes.some(existente => existente.consecutivo === nueva.consecutivo)) {
                            cotizacionesExistentes.push(nueva);
                        }
                    });

                    const jsonBlob = new Blob([JSON.stringify(cotizacionesExistentes, null, 2)], { type: "application/json" });
                    const accessToken = await getAccessToken();
                    const url = "https://graph.microsoft.com/v1.0/sites/selco534.sharepoint.com,xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx,yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy/drives/b!KxRr5AdKekWRE2On77gV-_REcnJYw_BJqAH5TSSxbCFOxffOJMG9RJ5EaCkpnjUS/root:/03. Obras cotizadas/Cotizaciones WEB/cotizaciones.json:/content";
                    const response = await fetch(url, {
                        method: "PUT",
                        headers: {
                            "Authorization": "Bearer " + accessToken,
                            "Content-Type": "application/json"
                        },
                        body: jsonBlob
                    });
                    if (!response.ok) throw new Error("Error al importar cotizaciones a SharePoint");
                    filtrarCotizaciones();
                    alert("Cotizaciones importadas con éxito.");
                } catch (error) {
                    console.error("Error al importar cotizaciones:", error);
                    alert("Error al importar el archivo JSON. Asegúrate de que sea válido.");
                }
            };
            reader.readAsText(file);
        }

        document.getElementById('margen_contributivo').addEventListener('input', calcularAPU);
        window.onload = function() {
            calcularAPU();
            calcularCotizacion();
            actualizarConsecutivo();
            actualizarTasaCambio();
            actualizarLabelMoneda();
            toggleAIUFields();
            filtrarCotizaciones();
        };
    </script>
</body>
</html>